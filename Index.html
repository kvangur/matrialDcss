<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>XML TV — Просмотрщик каналов</title>
<style>
  :root{
    --bg:#0f1720; --card:#0b1320; --muted:#94a3b8; --accent:#60a5fa; --glass: rgba(255,255,255,0.04);
    --radius:14px; --max-width:1100px;
  }
  html,body{height:100%; margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto; background:
    linear-gradient(180deg,#071027 0%, #07182a 60%); color:#e6eef8;}
  .wrap{max-width:var(--max-width); margin:28px auto; padding:20px; border-radius:18px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow: 0 6px 30px rgba(2,6,23,0.6);}
  header{display:flex; gap:12px; align-items:center; margin-bottom:14px;}
  h1{font-size:20px; margin:0; letter-spacing:-0.2px;}
  .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:12px 0 18px;}
  input[type="text"], textarea, select {background:var(--card); border:1px solid rgba(255,255,255,0.03); color:inherit; padding:8px 10px; border-radius:10px; outline:none; min-width:180px;}
  textarea{min-height:80px; min-width:420px; resize:vertical;}
  button{background:linear-gradient(90deg,var(--accent), #3b82f6); border:none; color:white; padding:8px 12px; border-radius:10px; cursor:pointer;}
  button.secondary{background:transparent; border:1px solid rgba(255,255,255,0.05); color:var(--muted);}
  .status{color:var(--muted); font-size:13px;}
  .toolbar{display:flex; gap:10px; align-items:center; margin-left:auto;}
  .list{display:grid; grid-template-columns: 1fr; gap:8px;}
  .card{display:flex; gap:12px; align-items:center; padding:10px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border:1px solid rgba(255,255,255,0.02);}
  .icon{width:56px; height:56px; flex:0 0 56px; border-radius:8px; background:rgb(228, 227, 227); display:flex; align-items:center; justify-content:center; overflow:hidden;}
  .icon img{width:100%; height:100%; object-fit:contain; display:block;}
  .meta{flex:1; min-width:0;}
  .name{font-weight:600; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .sub{font-size:13px; color:var(--muted); margin-top:4px; display:flex; gap:12px; flex-wrap:wrap;}
  .actions{display:flex; gap:8px; align-items:center;}
  .pill{padding:6px 8px; border-radius:999px; background:rgba(255,255,255,0.02); font-size:12px; color:var(--muted);}
  .search{min-width:220px;}
  .footer{display:flex; justify-content:space-between; align-items:center; margin-top:14px; color:var(--muted); font-size:13px;}
  .loader{height:6px; width:200px; background:rgba(255,255,255,0.03); border-radius:6px; overflow:hidden;}
  .loader > i{display:block; height:100%; background:linear-gradient(90deg,#60a5fa,#3b82f6); width:0%; transition:width 300ms linear;}
  .date-row{display:flex; gap:10px; align-items:center; margin-bottom:12px;}
  input[type="date"]{background:var(--accent); border:1px solid rgba(179, 164, 164, 0.03); color:inherit; padding:8px 10px; border-radius:8px; outline:none;}
  @media (max-width:780px){
    textarea{min-width:100%;}
    .controls{flex-direction:column; align-items:stretch;}
    .toolbar{margin-left:0;}
    .icon{width:48px;height:48px;flex:0 0 48px;}
  }

  /* ---------- Встроенные стили EPG (неймспейс .epg-embed) ---------- */
  .epg-embed{font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto; color:inherit; margin-top:10px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border:1px solid rgba(255,255,255,0.02); padding:10px; box-shadow:0 10px 30px rgba(2,6,23,0.45);}
  .epg-topbar{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px; flex-wrap:wrap;}
  .epg-dates{display:flex; gap:8px; align-items:center; overflow:auto; padding:6px 4px;}
  .epg-dateItem{padding:6px 10px; border-radius:10px; cursor:pointer; text-align:center; user-select:none; background:rgba(255,255,255,0.01); color:var(--muted); font-size:13px; border:1px solid rgba(255,255,255,0.01);}
  .epg-dateItem.active{background:linear-gradient(90deg,var(--accent),#3b82f6); color:#fff; font-weight:600; transform:translateY(-2px);}
  .epg-controls{display:flex; gap:8px; align-items:center;}
  .epg-programmes{overflow:auto; max-height:460px; padding-top:0px; padding-left:8px; padding-right:8px; border-radius:8px; background:linear-gradient(180deg, rgba(255,255,255,0.00), rgba(255,255,255,0.005)); position:relative;}
  .epg-channel-head{display:flex; gap:10px; align-items:center; margin-bottom:8px;}
  .epg-chlogo{width:48px; height:48px; border-radius:10px; background:#fff; object-fit:contain; flex-shrink:0; display:block;}
  .epg-daySection{margin-bottom:10px;}
  .epg-stickyDate{font-weight:700; color:var(--muted); margin-bottom:8px; position:sticky; top:0; background:linear-gradient(180deg,#071027,#07182a); padding:6px 8px; z-index:5; border-radius:6px;}
  .epg-program{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border-radius:8px; padding:10px; margin-bottom:8px; transition:transform .18s ease, box-shadow .18s ease; display:flex; gap:12px; align-items:flex-start;}
  .epg-program:hover{transform:translateY(-4px); box-shadow:0 12px 24px rgba(0,0,0,0.5);}
  .epg-time{color:var(--accent); font-weight:600; min-width:64px; font-size:13px; text-align:left;}
  .epg-title{font-weight:600; font-size:14px;}
  .epg-desc{font-size:13px; color:#cfe7ff; opacity:0.95; line-height:1.4;}
  .epg-meta{font-size:12px; color:var(--muted); margin-top:6px; display:flex; gap:8px; flex-wrap:wrap;}
  .epg-divider{height:1px; background:rgba(255,255,255,0.03); margin:8px 0; border-radius:1px;}
  .epg-compact .epg-program{padding:6px; gap:10px; align-items:center;}
  .epg-compact .epg-time{min-width:56px; font-size:12px;}
  .epg-compact .epg-title{font-size:13px;}
  .epg-compact .epg-desc, .epg-compact .epg-meta { display:none; }
  .epg-empty{color:var(--muted); padding:12px; text-align:center;}
  .epg-loading{color:var(--muted); padding:12px; text-align:center;}

  /* Scrollbar styling (match channel.html) */
  .epg-programmes::-webkit-scrollbar{width:12px;}
  .epg-programmes::-webkit-scrollbar-track{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border-radius:12px;}
  .epg-programmes::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--accent),#3b82f6);border-radius:12px;border:3px solid rgba(15,23,32,0.6);}

  /* responsive */
  @media (max-width:880px){
    .epg-chlogo{width:40px;height:40px;}
    .epg-time{min-width:56px;}
    .epg-programmes{max-height:320px;}
  }
</style>
</head>
<body>
<div class="wrap" role="main">
  <section class="controls">
    <button id="loadBtn">Загрузить список каналов</button>
    <div style="flex:1"></div>
    <input id="search" class="search" type="text" placeholder="Поиск по названию" />
    <select id="sort">
      <option value="name_asc">Сорт: имя ↑</option>
      <option value="name_desc">Сорт: имя ↓</option>
    </select>
  </section>

  <div class="date-row">
    <label for="weekPicker" class="hint">Неделя (только понедельники):</label>
    <input id="weekPicker" type="date" />
  </div>

  <section style="margin-bottom:8px;">
    <div id="statusLine" class="status">Готов.</div>
    <div style="margin-top:6px;">
      <div class="loader"><i id="loaderBar"></i></div>
    </div>
  </section>

  <section>
    <div id="list" class="list"></div>
    <div id="sentinel" style="height:18px"></div>
  </section>

  <div class="footer">
    <div id="summary">Каналов: 0</div>
  </div>
</div>

<script>
(() => {
  const FIXED_URL = 'https://circumvention-cors-easy.kvangur.workers.dev/?url=https://xmldata.epgservice.ru/EPGService/hs/xmldata/f91e4677-43da-4fb5-a3d4-f467f7aff51/index';
  const $ = id => document.getElementById(id);
  const listEl = $('list');
  const searchInput = $('search');
  const sortSelect = $('sort');
  const weekPicker = $('weekPicker');
  const summary = $('summary');
  const loaderBar = $('loaderBar');
  const statusLine = $('statusLine');
  const sentinel = $('sentinel');

  let channels = [], filtered = [], renderIndex = 0, observer = null;
  const PAGE = 150;

  function setStatus(t,p=0){statusLine.textContent=t;loaderBar.style.width=p+'%';}

  function parseXmlText(t){return new DOMParser().parseFromString(t,"application/xml");}

  // extract channels and store original href as origHref; dedupe by id
  function extractChannels(doc){
    const map = new Map();
    const nodes = [...doc.getElementsByTagName('channel')];
    nodes.forEach(n => {
      const id = n.getAttribute('id') || '';
      if (!id) return;
      if (map.has(id)) return; // dedupe
      const name = (n.querySelector('display-name[lang="ru"]') || n.querySelector('display-name'))?.textContent.trim() || '';
      const baseCh = n.querySelector('base-channel')?.textContent.trim() || '';
      const icon = n.querySelector('icon')?.getAttribute('src') || '';
      const href = n.querySelector('href')?.textContent.trim() || '';
      map.set(id, { id, name, baseCh, icon, origHref: href, href: href, rawNode: n.outerHTML, _epgOpen:false, _epgContainer:null });
    });
    return Array.from(map.values());
  }

  function normalizeToIsoDate(s){
    if(/^\d{4}-\d{2}-\d{2}$/.test(s))return s;
    const m=s.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
    if(m)return`${m[3]}-${m[2]}-${m[1]}`;
    const d=new Date(s);
    return isNaN(d)?null:d.toISOString().split('T')[0];
  }

  function getLastMonday(d){d=new Date(d);d.setDate(d.getDate()-((d.getDay()+6)%7));return d;}

  async function loadFromUrl(url){
    try{
      setStatus('Загрузка XML...',10);
      const t = await (await fetch(url)).text();
      const doc = parseXmlText(t);
      const weekEl = doc.querySelector('week');
      const iso = weekEl?normalizeToIsoDate(weekEl.textContent.trim()):null;
      weekPicker.value = iso||getLastMonday(new Date()).toISOString().split('T')[0];
      channels = extractChannels(doc);
      updateChannelHrefs();
      applyFilterAndSort();
      setupObserver();
      setStatus('Готово',100);
    }catch(err){
      setStatus('Ошибка загрузки: '+err.message,0);
      console.error(err);
    }
  }

  // use origHref to (re)build proxied href
  function updateChannelHrefs(){
    const selected = weekPicker.value;
    channels.forEach(c=>{
      if (c.origHref) {
        const base = c.origHref.split('?')[0];
        c.href = `https://circumvention-cors-easy.kvangur.workers.dev/?url=${base}?week=${selected}`;
      }
    });
  }

  function applyFilterAndSort(){
    const q = searchInput.value.trim().toLowerCase();
    filtered = channels.filter(c => !q || c.name.toLowerCase().includes(q) || c.baseCh.toLowerCase().includes(q));
    filtered.sort((a,b)=>sortSelect.value==='name_desc'?b.name.localeCompare(a.name,'ru'):a.name.localeCompare(b.name,'ru'));
    listEl.innerHTML='';
    summary.textContent=`Каналов: ${filtered.length}`;
    renderIndex=0;
    renderMore();
  }

  function createCard(c){
    const el = document.createElement('div');
    el.className = 'card';
    el.dataset.chanId = c.id;

    const icon = document.createElement('div');
    icon.className = 'icon';
    if(c.icon){
      const img = document.createElement('img');
      img.src = c.icon;
      img.loading = 'lazy';
      img.onerror = ()=>{ img.style.display='none'; icon.textContent='📺'; };
      icon.appendChild(img);
    } else icon.textContent='📺';

    const meta = document.createElement('div');
    meta.className = 'meta';
    const name = document.createElement('div');
    name.className = 'name';
    name.textContent = c.name||c.baseCh||c.id;
    const sub = document.createElement('div');
    sub.className = 'sub';
    const p1 = document.createElement('div');
    p1.className = 'pill';
    p1.textContent = `ID: ${c.id}`;
    sub.appendChild(p1);
    meta.appendChild(name);
    meta.appendChild(sub);

    const actions = document.createElement('div');
    actions.className = 'actions';
    // Program button:
    const btnProg = document.createElement('button');
    btnProg.textContent = 'Программа';
    btnProg.onclick = async () => {
      await toggleProgramForChannel(c, el, btnProg);
    };

    actions.append(btnProg);
    el.append(icon, meta, actions);

    return el;
  }

  function renderMore(){
    const end = Math.min(filtered.length, renderIndex + PAGE);
    const f = document.createDocumentFragment();
    for(let i=renderIndex;i<end;i++) f.append(createCard(filtered[i]));
    listEl.append(f);
    renderIndex=end;
  }

  function setupObserver(){
    if(observer) observer.disconnect();
    observer = new IntersectionObserver(e => { if(e[0].isIntersecting) renderMore(); }, {root:null, rootMargin:'200px'});
    observer.observe(sentinel);
  }

  /* ------------------ EPG embed logic (adapted from channel.html) ------------------ */

  function fmtTime(attr){
    if (!attr) return '';
    const s = attr.replace(/\s.*$/,'');
    if (s.length < 12) return s;
    const hh = s.slice(8,10), mm = s.slice(10,12);
    return `${hh}:${mm}`;
  }
  function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

  async function toggleProgramForChannel(channel, cardEl, toggleButton){
    // close if open
    if (channel._epgOpen) {
      const cont = channel._epgContainer;
      if (cont) {
        // disconnect observers stored on container
        try { if (cont._io) cont._io.disconnect(); } catch(e){}
        try { if (cont._cardObserver) cont._cardObserver.disconnect(); } catch(e){}
        cont.remove();
      }
      channel._epgContainer = null;
      channel._epgOpen = false;
      toggleButton.textContent = 'Программа';
      return;
    }

    // create container
    const container = document.createElement('div');
    container.className = 'epg-embed';
    container.innerHTML = `
      <div class="epg-topbar">
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="epg-channel-head">
            <img class="epg-chlogo" alt="logo" style="display:none" />
            <div style="font-weight:700" class="epg-chname">Загрузка...</div>
          </div>
        </div>
        <div class="epg-controls">
          <div class="epg-dates" role="tablist" aria-label="Даты"></div>
          <button class="secondary epg-compact-toggle" title="Компактный вид">Компактный вид</button>
          <button class="secondary epg-today-btn" title="Перейти к сегодняшнему дню">Сегодня</button>
        </div>
      </div>
      <div class="epg-programmes"></div>
    `;
    // insert under card
    cardEl.after(container);
    channel._epgContainer = container;
    channel._epgOpen = true;
    toggleButton.textContent = 'Свернуть';

    const chLogoEl = container.querySelector('.epg-chlogo');
    const chNameEl = container.querySelector('.epg-chname');
    const datesBar = container.querySelector('.epg-dates');
    const programmesEl = container.querySelector('.epg-programmes');
    const compactToggle = container.querySelector('.epg-compact-toggle');
    const todayBtn = container.querySelector('.epg-today-btn');

    // show loading
    programmesEl.innerHTML = `<div class="epg-loading">Загрузка данных канала...</div>`;

    // if no href (origHref) — show message
    if (!channel.origHref) {
      programmesEl.innerHTML = `<div class="epg-empty">Ссылка на программу отсутствует</div>`;
      return;
    }

    // fetch XML
    try {
      const resp = await fetch(channel.href);
      if (!resp.ok) {
        const txt = await resp.text().catch(()=>'<no body>');
        programmesEl.innerHTML = `<div class="epg-empty">Ошибка HTTP ${resp.status} ${resp.statusText}<br><small>${escapeHtml(txt)}</small></div>`;
        return;
      }
      const xmlText = await resp.text();
      const doc = parseXmlText(xmlText);
      if (doc.querySelector && doc.querySelector('parsererror')) {
        programmesEl.innerHTML = `<div class="epg-empty">Ошибка парсинга XML</div>`;
        console.error('XML parse error', doc.querySelector('parsererror')?.textContent);
        return;
      }

      // header
      const chNode = doc.querySelector('channel');
      if (chNode) {
        const name = chNode.querySelector('display-name')?.textContent || chNode.getAttribute('id') || 'Канал';
        chNameEl.textContent = name;
        const iconSrc = chNode.querySelector('icon')?.getAttribute('src');
        if (iconSrc) { chLogoEl.src = iconSrc; chLogoEl.style.display = 'block'; chLogoEl.loading = 'lazy'; }
      }

      const progs = [...doc.getElementsByTagName('programme')];
      if (progs.length === 0) {
        programmesEl.innerHTML = `<div class="epg-empty">Нет программ</div>`;
        return;
      }

      const data = progs.map(p => {
        const start = p.getAttribute('start') || '';
        const stop = p.getAttribute('stop') || '';
        const title = p.querySelector('title')?.textContent || 'Без названия';
        const desc = p.querySelector('desc')?.textContent || '';
        const category = p.querySelector('category')?.textContent || '';
        const genre = p.querySelector('genre')?.textContent || '';
        const age = p.querySelector('rating')?.textContent || '';
        let date = (p.querySelector('date')?.textContent || '').trim();
        if (/^\d{8}$/.test(date)) date = `${date.slice(0,4)}-${date.slice(4,6)}-${date.slice(6,8)}`;
        else if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
          const s = start.replace(/\s.*$/,'');
          if (/^\d{14}$/.test(s)) date = `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
        }
        return { start, stop, title, desc, category, genre, age, date };
      });

      const grouped = {};
      data.forEach(it => {
        const d = it.date || 'unknown';
        if (!grouped[d]) grouped[d] = [];
        grouped[d].push(it);
      });

      let dates = Object.keys(grouped).filter(d=>d!=='unknown').sort((a,b)=>a.localeCompare(b));
      if (dates.length === 0) {
        data.forEach(it => {
          const s = it.start.replace(/\s.*$/,'');
          if (s.length >= 8) {
            const d = `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
            it.date = d;
            if (!grouped[d]) grouped[d] = [];
            grouped[d].push(it);
          }
        });
        dates = Object.keys(grouped).filter(d=>d!=='unknown').sort((a,b)=>a.localeCompare(b));
      }

      if (dates.length === 0) {
        programmesEl.innerHTML = `<div class="epg-empty">Не удалось определить даты в документе</div>`;
        return;
      }

      // render date buttons (top)
      datesBar.innerHTML = '';
      dates.forEach(d => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'epg-dateItem';
        btn.dataset.date = d;
        const weekday = new Date(d).toLocaleDateString('ru-RU',{weekday:'short'});
        const daynum = new Date(d).getDate();
        btn.innerHTML = `<div style="font-size:13px">${weekday}</div><div style="font-weight:600">${daynum}</div>`;
        btn.onclick = (e) => {
  e.preventDefault();
  const target = container.querySelector(`[data-epg-day="${d}"]`);
  if (target) {
    // плавный скролл без фокуса
    target.parentElement.scrollTo({ top: target.offsetTop, behavior: 'smooth' });
    highlightDate(d);
  }
};

        datesBar.appendChild(btn);
      });

      // render programmes list
      programmesEl.innerHTML = '';
      const dayBlocks = {};
      dates.forEach(d => {
        const section = document.createElement('div');
        section.className = 'epg-daySection';
        section.dataset.epgDay = d;

        const sticky = document.createElement('div');
        sticky.className = 'epg-stickyDate';
        sticky.textContent = new Date(d).toLocaleDateString('ru-RU',{weekday:'long', day:'2-digit', month:'long'});
        section.appendChild(sticky);

        (grouped[d] || []).forEach((p, idx) => {
          const card = document.createElement('div');
          card.className = 'epg-program';
          let metaHtml = '';
          if(p.category) metaHtml += `<div>Категория: ${escapeHtml(p.category)}</div>`;
          if(p.genre) metaHtml += `<div>Жанр: ${escapeHtml(p.genre)}</div>`;
          if(p.age) metaHtml += `<div>Возраст: ${escapeHtml(p.age)}</div>`;
          card.innerHTML = `
            <div class="epg-time">${fmtTime(p.start)}</div>
            <div style="flex:1">
              <div class="epg-title">${escapeHtml(p.title)}</div>
              ${p.desc ? `<div class="epg-desc">${escapeHtml(p.desc)}</div>` : ''}
              ${metaHtml ? `<div class="epg-meta">${metaHtml}</div>` : ''}
            </div>
          `;
          section.appendChild(card);
          if (idx < (grouped[d] || []).length - 1) {
            const div = document.createElement('div');
            div.className = 'epg-divider';
            section.appendChild(div);
          }
        });

        programmesEl.appendChild(section);
        dayBlocks[d] = section;
      });

      function highlightDate(d){
        Array.from(datesBar.children).forEach(el => el.classList.toggle('active', el.dataset.date === d));
      }

      // today button
      const todayIso = new Date().toISOString().split('T')[0];
      todayBtn.onclick = () => {
        const nearest = dates.find(dd => dd >= todayIso) || dates[0];
        const target = container.querySelector(`[data-epg-day="${nearest}"]`);
        if (target) target.scrollIntoView({behavior:'smooth', block:'start'});
        highlightDate(nearest);
      };

      // observers: keep references on container for later disconnection
      const observerOptions = { root: programmesEl, rootMargin: '0px 0px -50% 0px', threshold: 0.01 };
      const io = new IntersectionObserver((entries) => {
        const visible = entries.filter(e => e.isIntersecting).sort((a,b)=>b.intersectionRatio - a.intersectionRatio)[0];
        if (visible) {
          const d = visible.target.dataset.epgDay;
          if (d) highlightDate(d);
        }
      }, observerOptions);
      Object.values(dayBlocks).forEach(b => io.observe(b));
      container._io = io;

      // compact toggle
      let compact = false;
      const cardObserver = new IntersectionObserver((entries) => {
        entries.forEach(en => {
          if (en.isIntersecting) {
            en.target.classList.add('visible'); // optional, currently no anim classes used but harmless
          }
        });
      }, { root: programmesEl, threshold: 0.06 });
      programmesEl.querySelectorAll('.epg-program').forEach(card => cardObserver.observe(card));
      container._cardObserver = cardObserver;

      compactToggle.onclick = (e) => {
        e.preventDefault();
        compact = !compact;
        if (compact) {
          container.classList.add('epg-compact');
          compactToggle.textContent = 'Полный вид';
        } else {
          container.classList.remove('epg-compact');
          compactToggle.textContent = 'Компактный вид';
        }
      };

      // initial highlight and scroll
      highlightDate(dates[0]);
      const first = container.querySelector(`[data-epg-day="${dates[0]}"]`);
      if (first) first.scrollIntoView({behavior:'auto', block:'start'});

    } catch (err) {
      console.error('Fetch/parse error:', err);
      programmesEl.innerHTML = `<div class="epg-empty">Ошибка загрузки XML: ${escapeHtml(err.message || String(err))}</div>`;
    }
  }

  /* ------------------ UI events ------------------ */
  $('loadBtn').onclick = () => loadFromUrl(FIXED_URL);
  searchInput.oninput = applyFilterAndSort;
  sortSelect.onchange = applyFilterAndSort;

  weekPicker.oninput = e => {
    const val = e.target.value;
    if (!val) return;
    const d = new Date(val+'T00:00:00');
    if (d.getDay() !== 1){
      alert('Можно выбрать только понедельник');
      e.target.value = getLastMonday(new Date()).toISOString().split('T')[0];
      return;
    }
    updateChannelHrefs();
  };

  // initial state
  setStatus('Готов. Нажмите «Загрузить список каналов».');

})();
</script>
</body>
</html>


